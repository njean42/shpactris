[gd_scene load_steps=16 format=2]

[ext_resource path="res://assets/controller/kbd_ship.png" type="Texture" id=1]
[ext_resource path="res://assets/controller/2p_pacman.png" type="Texture" id=2]
[ext_resource path="res://assets/ship.png" type="Texture" id=3]
[ext_resource path="res://assets/controller/kbd_pacman.png" type="Texture" id=4]
[ext_resource path="res://assets/controller/2p_ship.png" type="Texture" id=5]
[ext_resource path="res://assets/pacman.png" type="Texture" id=6]
[ext_resource path="res://assets/controller/1p.png" type="Texture" id=7]
[ext_resource path="res://assets/controller/xb_y.png" type="Texture" id=8]
[ext_resource path="res://assets/controller/xb_x.png" type="Texture" id=9]

[sub_resource type="GDScript" id=1]
script/source = "extends MarginContainer


var device_id_ship = null
var device_id_pacman = null

onready var i_am_pacman = get_tree().network_peer == null or get_tree().get_network_unique_id() != lobby.pacman
onready var i_am_the_ship = get_tree().network_peer == null or get_tree().get_network_unique_id() != lobby.ship


func _ready():
	if not i_am_pacman:
		find_node('label-pacman').text = 'Controlled by the other player'
	
	if not i_am_the_ship:
		find_node('label-ship').text = 'Controlled by the other player'
	
	update_mode()
	update_pics()
	find_node(\"bt-continue\").grab_focus()


func _input(event):
	
	if not ('button_index' in event):
		return
	
	if not event.is_pressed():
		return
	
	# X to switch between keyboard/controller for the ship
	if event.button_index == JOY_BUTTON_2 and i_am_the_ship:
		device_id_ship = event.device if device_id_ship == null else null
		find_node('label-ship').text = 'Controller '+str(device_id_ship+1) if device_id_ship != null else 'Keyboard'
		get_tree().set_input_as_handled()
		update_mode()
	
	# Y to switch between keyboard/controller for pacman
	elif event.button_index == JOY_BUTTON_3 and i_am_pacman:
		device_id_pacman = event.device if device_id_pacman == null else null
		find_node('label-pacman').text = 'Controller '+str(device_id_pacman+1) if device_id_pacman != null else 'Keyboard'
		get_tree().set_input_as_handled()
		update_mode()


func update_mode():
	var mode_1p = device_id_ship == device_id_pacman
	global.PLAYERS.ship = device_id_ship
	global.PLAYERS.pacman = device_id_pacman
	global.PLAYERS.mode_1p = mode_1p
	
	# reset all actions to defaults
	InputMap.load_from_globals()
	
	for action in InputMap.get_actions():
		for event in InputMap.get_action_list(action):
			if not (event is InputEventJoypadButton) and not (event is InputEventJoypadMotion):
				continue
			
			if action.find('_ship_') != -1:
				event.set_device(device_id_ship if device_id_ship != null else 1000)
			
			if action.find('_pacman_') != -1:
				event.set_device(device_id_pacman if device_id_pacman != null else 1000)
			
			# deactivate 2p_mode actions when playing solo
			if global.PLAYERS.mode_1p and action.begins_with('2p_mode'):
				InputMap.action_erase_event(action,event)
			
			# deactivate controller for the ship if playing on keyboard
			if device_id_ship == null and action.begins_with('2p_mode_ship_'):
				InputMap.action_erase_event(action,event)
			
			# deactivate controller for pacman if playing on keyboard
			if device_id_pacman == null and action.begins_with('2p_mode_pacman_'):
				InputMap.action_erase_event(action,event)
	
	update_pics()


func update_pics():
	for m in ['2p_pacman', 'kbd_pacman', '2p_ship', 'kbd_ship', '1p']:
		find_node(m).visible = false
	
	var mode_1p = global.PLAYERS.ship == global.PLAYERS.pacman
	
	# solo on controller
	if mode_1p and global.PLAYERS.ship != null:
		for pic in ['1p']:
			find_node(pic).visible = true
	
	#Â solo on keyboard
	elif mode_1p:
		for pic in ['kbd_pacman', 'kbd_ship']:
			find_node(pic).visible = true
	
	# 2p mode on controllers
	elif global.PLAYERS.ship != null and global.PLAYERS.pacman != null:
		for pic in ['2p_pacman', '2p_ship']:
			find_node(pic).visible = true
	
	# 2p mode, controller for the ship
	elif global.PLAYERS.ship != null:
		for pic in ['kbd_pacman', '2p_ship']:
			find_node(pic).visible = true
	
	# 2p mode, controller for pacman
	else:
		for pic in ['2p_pacman', 'kbd_ship']:
			find_node(pic).visible = true
	
	if not i_am_pacman:
		for m in ['2p_pacman', 'kbd_pacman']:
			find_node(m).visible = false
	
	if not i_am_the_ship:
		for m in ['2p_ship', 'kbd_ship']:
			find_node(m).visible = false
"

[sub_resource type="DynamicFontData" id=2]
font_path = "res://assets/DejaVuSans-Bold.ttf"

[sub_resource type="DynamicFont" id=3]
font_data = SubResource( 2 )

[sub_resource type="DynamicFontData" id=4]
font_path = "res://assets/DejaVuSans-Bold.ttf"

[sub_resource type="DynamicFont" id=5]
size = 28
font_data = SubResource( 4 )

[sub_resource type="GDScript" id=6]
script/source = "extends Button


func _on_btcontinue_pressed():
	get_tree().change_scene(\"res://scenes/world.tscn\")
"

[node name="controls" type="MarginContainer"]
margin_left = 10.0
margin_top = 10.0
margin_right = 590.0
margin_bottom = 710.0
script = SubResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="vbox" type="VBoxContainer" parent="."]
margin_right = 580.0
margin_bottom = 700.0

[node name="center-pacman" type="CenterContainer" parent="vbox"]
margin_right = 580.0
margin_bottom = 38.0
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="hbox-pacman" type="HBoxContainer" parent="vbox/center-pacman"]
margin_left = 208.0
margin_right = 371.0
margin_bottom = 38.0

[node name="pacman" type="TextureRect" parent="vbox/center-pacman/hbox-pacman"]
margin_right = 38.0
margin_bottom = 38.0
texture = ExtResource( 6 )

[node name="label-pacman" type="Label" parent="vbox/center-pacman/hbox-pacman"]
margin_left = 42.0
margin_top = 9.0
margin_right = 127.0
margin_bottom = 28.0
custom_fonts/font = SubResource( 3 )
text = "Keyboard"

[node name="hint" type="TextureRect" parent="vbox/center-pacman/hbox-pacman"]
margin_left = 131.0
margin_right = 163.0
margin_bottom = 38.0
size_flags_horizontal = 3
size_flags_vertical = 3
texture = ExtResource( 8 )

[node name="center" type="CenterContainer" parent="vbox"]
margin_top = 42.0
margin_right = 580.0
margin_bottom = 274.0

[node name="2p_pacman" type="TextureRect" parent="vbox/center"]
margin_right = 580.0
margin_bottom = 232.0
texture = ExtResource( 2 )
stretch_mode = 1

[node name="center2" type="CenterContainer" parent="vbox"]
margin_top = 278.0
margin_right = 580.0
margin_bottom = 313.0
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="kbd_pacman" type="TextureRect" parent="vbox/center2"]
visible = false
margin_left = 89.0
margin_top = -69.0
margin_right = 490.0
margin_bottom = 104.0
texture = ExtResource( 4 )

[node name="center-ship" type="CenterContainer" parent="vbox"]
margin_top = 317.0
margin_right = 580.0
margin_bottom = 368.0
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="hbox-ship" type="HBoxContainer" parent="vbox/center-ship"]
margin_left = 197.0
margin_right = 382.0
margin_bottom = 51.0

[node name="ship" type="TextureRect" parent="vbox/center-ship/hbox-ship"]
margin_right = 60.0
margin_bottom = 51.0
texture = ExtResource( 3 )

[node name="label-ship" type="Label" parent="vbox/center-ship/hbox-ship"]
margin_left = 64.0
margin_top = 16.0
margin_right = 149.0
margin_bottom = 35.0
custom_fonts/font = SubResource( 3 )
text = "Keyboard"

[node name="hint" type="TextureRect" parent="vbox/center-ship/hbox-ship"]
margin_left = 153.0
margin_right = 185.0
margin_bottom = 51.0
size_flags_horizontal = 3
size_flags_vertical = 3
texture = ExtResource( 9 )

[node name="center3" type="CenterContainer" parent="vbox"]
margin_top = 372.0
margin_right = 580.0
margin_bottom = 614.0

[node name="2p_ship" type="TextureRect" parent="vbox/center3"]
margin_left = 6.0
margin_right = 574.0
margin_bottom = 242.0
texture = ExtResource( 5 )
stretch_mode = 1

[node name="center4" type="CenterContainer" parent="vbox"]
margin_top = 618.0
margin_right = 580.0
margin_bottom = 653.0
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="kbd_ship" type="TextureRect" parent="vbox/center4"]
visible = false
margin_left = 89.0
margin_top = -62.0
margin_right = 490.0
margin_bottom = 96.0
texture = ExtResource( 1 )

[node name="1p" type="TextureRect" parent="vbox"]
visible = false
margin_top = 768.0
margin_right = 580.0
margin_bottom = 1033.0
texture = ExtResource( 7 )
stretch_mode = 1

[node name="hbox" type="HBoxContainer" parent="vbox"]
margin_top = 657.0
margin_right = 580.0
margin_bottom = 657.0

[node name="center5" type="CenterContainer" parent="vbox"]
margin_top = 661.0
margin_right = 580.0
margin_bottom = 700.0
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="bt-continue" type="Button" parent="vbox/center5"]
margin_left = 203.0
margin_right = 377.0
margin_bottom = 39.0
custom_fonts/font = SubResource( 5 )
text = "CONTINUE"
script = SubResource( 6 )
[connection signal="pressed" from="vbox/center5/bt-continue" to="vbox/center5/bt-continue" method="_on_btcontinue_pressed"]
